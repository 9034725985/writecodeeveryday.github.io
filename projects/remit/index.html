<html>
	<head>
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/bootstrap-theme.min.css">
		<script src="js/jquery-2.1.3.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
	</head>

	<body>
		<div class="col-lg-12">
			<h2 align="center"> Remit With Bitcoin (Assume $100 USD) </h2>
		</div>
		<div class="col-lg-12">
			<table class="table" id="master-table">
				<tr>
					<th>Name</th>
					<th>Region</th>
					<th>Local Currency</th>
					<th>Cost to Transfer</th>
					<th>Exchange</th>
				</tr>
			</table>
		</div>
		<script type="text/javascript">
			var usdPrice;
			var currencies;
			var countries = [];
			$(document).ready(function (){
				$.get("https://api.bitcoinaverage.com/ticker/global/USD/", getBTCUSD);
				$.get("http://api.fixer.io/latest?base=USD", processValidCurrencies);
			});

			function getBTCUSD(data)
			{
				usdPrice = Number(data.last);
			}

			function processValidCurrencies(data)
			{
				currencies = data.rates;
				$.get("https://restcountries.eu/rest/v1/all", processCountries);
			}
			function processCountries(data)
			{
				//value = $("#master-table").html();
				//value += "<tr><td>"+country.name+"</td><td>"+country.region+"</td><td>"+country.currencies[0]+"</td><tr>";
				//$("#master-table").html(value);

				var value = 1;
				$.each(data, function(i, country){
					if(country.currencies[0] in currencies){
						setTimeout( function() {
							countries.push(country);
							extractExchange(country, country.name, country.currencies[0]);
						}, 100 * value);
						value++;
					}
				});
			}

			function extractExchange(country, name, currency)
			{
				var finalName = name.replace(new RegExp(" ", "g"), "-");
				finalName = finalName.toLowerCase();
				$.get("https://api.import.io/store/data/510491e5-fbfe-4034-8c46-2a41799fa3ab/_query?input/webpage/url=http%3A%2F%2Fbitcoinx.io%2Fexchanges%2F%3Ftag%3D"+finalName+"&_user=863f4dc2-969b-4155-96f3-9f681833ba96&_apikey=863f4dc2969b415596f39f681833ba964956008dd73edf72caa53ff9378a8767ea6f2ca10c2f9bb923106f7af83d7f784dd1e2931b6885fcf44bf1a61253fc41ee025b4da933d7f34d53d82b994d99ac", function(data){
					if (data.results.length > 0)
					{
						finalizePage(country, name, finalName, currency, data.results);
					}
				});
			}

			function finalizePage(country, name, finalName, currency, results)
			{
				var values = [];
				$.each(results, function (i, exchange)
				{
					var name = exchange.name;
					var url = exchange.desc.replace("URL: ", "");
					url = url.trim();
					url = url.substring(0, url.indexOf(" "));
					url = url.trim();

					//TODO - Need regex that doesn't suck ass.
					$.get("http://crossorigin.me/http://"+url, function(data){
						amount = data.search("\d{0,6}\.\d{2}");
						if (amount > -1)
						{
							var usdBTC = 100 / usdPrice;
							var usdToLocalCurrency = 100 * Number(currencies[currency]);
							var btcToLocalCurrency = usdBTC * Number(amount);

							value = $("#master-table").html();
							value += "<tr>"+
													"<td>"+country.name+"</td>"+
													"<td>"+country.region+"</td>"+
													"<td>"+currency+"</td>"+
													"<td>"+ ((usdToLocalCurrency/btcToLocalCurrency) * 100).toFixed(0) +"%</td>"+
													"<td><a href='http://"+url+"'>"+name+"</a></td>"+
												"<tr>";
							$("#master-table").html(value);
						}
					});
				});
			}
		</script>
	</body>
</html>
